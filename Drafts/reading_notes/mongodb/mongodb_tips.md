## 1 .连接问题

MongoClient 必须保证它是单例。

连接到复制集 （要保证所有节点都在写出来）

```
mongodb://节点1，节点2，节点3..../database?[options]
```

连接到分片集群 (写出所有 mongos)

```
mongodb://mongos1，mongos2，mongos3..../database?[options]
```

连接地址尽可能使用域名，实在不行才用 ip。用域名的好处是换机器的时候，不用改这方面的配置，只要域名解析调整一下到新机器的ip即可。

`mongodb+srv://` 协议了解一下，可以增加一层保护。该协议可以通过域名解析得到所有节点或mongos的地址。

#### 1.1 连接参数

MaxPoolSize: 可以用默认值

maxWaitTime: 建议设置，自动杀掉太慢的查询

Write concern ：建议majority 保证数据安全

Read concern: 对数据一致性要求高的场景适当使用



## 2. 不要在 mongos 或者复制集 前面使用负载均衡

本来驱动会自己处理 负载均衡 和自动故障恢复，加了负载均衡 反而没法处理了。

## 3. 游标使用注意事项

游标不使用了，要手动 close掉。

## 4. 关于查询和索引

每一个查询都必须要有对应的索引。 Mongodb 没有资源隔离，一个慢查询会影响所有。

尽量使用覆盖索引 coverd indexes（可以避免读数据文件）

使用 projection 减少返回到客户端的内容。（不要全量返回）

## 5. 关于写入

在update 只更新需要的字段，不要整个json 更新。

插入：尽量使用批量插入，不要一个一个插。

对于那些过一段时间就过期不要的数据，使用TTL来处理，不用自己写脚本删除。

## 6 文档结构设计

字段不要太长，不要用中文

少用太深的数组嵌套（2层就差不多了），尽可能展开。

## 7. 分页问题

禁止使用 count

避免使用  skit/ limit 分页，使用查询 + 排序 `find + sort + limit`  (ObjectId 是有规律自增的)

## 8 事务

事务成本还是很高的，尽量少用。

模型设计更重要。尽可能用模型设计来规避事务的使用。

事务不要太大（1000个文档以内）

尽量让事务所涉及的文档都在一个分片上，效率比较高。

